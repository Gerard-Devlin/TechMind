---
subtitle: Regression
---

[TOC]

---

!!! tip
    æœ¬æ–‡æ˜¯å¯¹äºæœºå™¨å­¦ä¹ åŸºç¡€æ¦‚å¿µçš„ç®€å•å›é¡¾ï¼Œå…·ä½“å¯ä»¥å‚ç…§ **[æœºå™¨å­¦ä¹ ï¼ˆMLï¼‰](../MLï¼†DL/1 ã€ç›‘ç£å­¦ä¹ .md)**çš„æ–‡æ¡£


## ä¸€ã€é€šç”¨æ­¥éª¤

- *step1*ï¼šæ‰¾å‡º $f$ æ¥**æ‹Ÿåˆ**

- *step2*ï¼šä»è®­ç»ƒå‡½æ•°å®šä¹‰ $Loss$ 

    - $$
      \begin{aligned}
      MAE:e = |y - \hat{y}| \\
       MSE:e = (y - \hat{y})^2
       \end{aligned}
      $$

-  *step3*ï¼š**æ¢¯åº¦ä¸‹é™**å¯»æ‰¾æœ€ä¼˜è§£ï¼ˆå±€éƒ¨ï¼‰

    - $$
      w^*,b^*=\arg \min_{w,b} L
      $$

!!! note
    **è¶…å‚æ•°**ï¼šéœ€è¦è‡ªå·±è®¾å®šçš„å‚æ•°ï¼Œe.g. æ¿€æ´»å‡½æ•°ã€batchã€epoch â€¦â€¦

---

## äºŒã€æ¿€æ´»å‡½æ•°

çº¿æ€§æ¨¡å‹ $y=\vec wÂ·\vec x+b$ ä¸èƒ½æ‹Ÿåˆå¤æ‚æƒ…å†µï¼Œéœ€è¦æ›´æœ‰**å¼¹æ€§**çš„å‡½æ•°

ç”¨è¶³å¤Ÿå¤šçš„æ¿€æ´»å‡½æ•°å‡‘å‡ºpiecewise linearï¼Œå†ç”¨è¶³å¤Ÿå¤šçš„piecewise linearæ¥é€¼è¿‘åŸæ¥çš„æ›²çº¿
$$
\begin{align}
y=cÂ·\frac{1}{1+e^{-(b+wx_1)}}\\
=cÂ·sigmoid(b+wx_1)
\end{align}
$$
é€šè¿‡è°ƒæ•´ $w,b,c$ æ¥ç»„åˆå‡ºä¸åŒçš„ $sigmoid$ å‡½æ•°

- è¿›è€Œæ”¹è¿›æ¨¡å‹
  $$
  f=y = b + \sum_i c_i \, \text{sigmoid} \left( b_i + \sum_j w_{ij} x_j \right)
  $$
  

![model.png](../assets/images/DL/model.png)

---

- æ”¹è¿› $Loss$

  å°†å‚æ•°å±•å¼€æˆåˆ—å‘é‡ $\theta$ï¼Œç„¶å $\theta^* = \arg\min_{\theta} L$


$$
\theta = \begin{bmatrix}
\theta_1 \\
\theta_2 \\
\theta_3 \\
\vdots
\end{bmatrix}
$$


  - éšæœºåˆå§‹åŒ– $\theta^0$


$$
\quad g_{gradient} = \begin{bmatrix}
\frac{\partial L}{\partial \theta_1} \bigg|_{\theta=\theta^0} \\
\frac{\partial L}{\partial \theta_2} \bigg|_{\theta=\theta^0} \\
\vdots
\end{bmatrix}
=\nabla L(\theta^0)
$$


!!! tip

    æŠŠæ•°æ®åˆ†æˆå¤šä¸ª `batch`ï¼Œ`1 epoch` = æŠŠæ‰€æœ‰ `batch` è¿è¡Œè¿‡ä¸€é
    
    - e.g. N = 10,000ï¼Œ B = 10ï¼Œæ¯ä¸ª`epoch`æ›´æ–°1,000 æ¬¡
    
    é€šè¿‡å¢åŠ ç½‘ç»œå±‚æ•°å¯ä»¥æ˜¾è‘—é™ä½ $Loss$
    
    Deep Learning ä¸­ Deep ä»£è¡¨æœ‰è®¸å¤šçš„éšè—å±‚ï¼Œä½†æ˜¯å…‰é€šè¿‡å å±‚æ•°ä¼šå¯¼è‡´**è¿‡æ‹Ÿåˆ**ï¼ˆoverfittingï¼‰çš„é—®é¢˜

---

## ä¸‰ã€åå‘ä¼ æ’­

$$
L(\theta) = \sum_{n=1}^{N} c^n(\theta)\Rightarrow
\frac{\partial L(\theta)}{\partial w} = \sum_{n=1}^{N} \frac{\partial c^n(\theta)}{\partial w}
$$

- å‰å‘ä¼ æ’­ï¼ˆForward passï¼‰
    - è®¡ç®—æ‰€æœ‰å‚æ•°çš„åå¯¼æ•° $\frac{\partial z}{\partial w}$ã€‚


- åå‘ä¼ æ’­ï¼ˆBackward passï¼‰

    - è®¡ç®—æ‰€æœ‰æ¿€æ´»å‡½æ•°è¾“å…¥ $z$ çš„åå¯¼æ•° $\frac{\partial C}{\partial z}$ã€‚

    - ç®€å•è®²æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼š

      **åå‘ä¼ æ’­æ˜¯é€šè¿‡é“¾å¼æ³•åˆ™ï¼Œå°†æŸå¤±å¯¹è¾“å‡ºçš„è¯¯å·®ï¼Œé€å±‚åå‘ä¼ æ’­ï¼Œè®¡ç®—å„å±‚å‚æ•°çš„æ¢¯åº¦ï¼Œä»è€Œç”¨æ¥æ›´æ–°å‚æ•°ï¼Œé™ä½æŸå¤±ã€‚**

![backward-pass.png](../assets/images/DL/backward-pass.png)

![forward-pass.png](../assets/images/DL/forward-pass.png)

---

## ğŸŒŸ HW01

<div class="grid cards" markdown>

- [:fontawesome-brands-git-alt: __HW01__ reference code -- â€œ__Regression__â€](https://github.com/Gerard-Devlin/NTU-EE5184/tree/main/HW01)

</div>

1ã€__Model__

!!! failure "Odd"
    å‘ç°ä¸ç”¨ `batchnorm` å’Œ `dropout` åè€Œæ•ˆæœæ›´å¥½

```python
class My_Model(nn.Module):
    def __init__(self, input_dim):
        super(My_Model, self).__init__()
        self.layers = nn.Sequential(
            # ç¬¬ä¸€å±‚
            nn.Linear(input_dim, 32),
            nn.LeakyReLU(),

            # ç¬¬äºŒå±‚
            nn.Linear(32, 16),
            nn.LeakyReLU(),

            # ç¬¬ä¸‰å±‚
            nn.Linear(16, 8),
            nn.LeakyReLU(),
			
            # è¾“å‡º
            nn.Linear(8, 1)
        )

    def forward(self, x):
        x = self.layers(x)
        x = x.squeeze(1) # (B, 1) -> (B)
        return x
```
??? tip "Architecture" 
        
    - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ç½‘ç»œæ¶æ„
    
    ```python
    from torchsummary import summary
    summary(model, input_size=(input_dim,))
    ```
    
    ```
    ----------------------------------------------------------------
            Layer (type)               Output Shape         Param #
    ================================================================
                Linear-1                   [-1, 32]             672
             LeakyReLU-2                   [-1, 32]               0
                Linear-3                   [-1, 16]             528
             LeakyReLU-4                   [-1, 16]               0
                Linear-5                    [-1, 8]             136
             LeakyReLU-6                    [-1, 8]               0
                Linear-7                    [-1, 1]               9
    ================================================================
    Total params: 1,345
    Trainable params: 1,345
    Non-trainable params: 0
    ----------------------------------------------------------------
    Input size (MB): 0.00
    Forward/backward pass size (MB): 0.00
    Params size (MB): 0.01
    Estimated Total Size (MB): 0.01
    ----------------------------------------------------------------
    ```

2ã€__Feature Selection__

```python
def select_feat(train_data, valid_data, test_data, select_all=True):
    '''Selects useful features to perform regression'''
    y_train, y_valid = train_data[:,-1], valid_data[:,-1]
    raw_x_train, raw_x_valid, raw_x_test = train_data[:,:-1], valid_data[:,:-1], test_data

    if select_all:
        feat_idx = list(range(raw_x_train.shape[1]))
    else:
        selector = SelectKBest(score_func=f_regression, k=20)  # é€‰æ‹© k ä¸ªæœ€ä½³ç‰¹å¾
        selector.fit(raw_x_train, y_train)  				# è®­ç»ƒç‰¹å¾é€‰æ‹©å™¨
        feat_idx = selector.get_support(indices=True)  		 # è·å–é€‰ä¸­çš„ç‰¹å¾ç´¢å¼•

        return raw_x_train[:,feat_idx], raw_x_valid[:,feat_idx], raw_x_test[:,feat_idx], y_train, y_valid
```

3ã€__Training Loop__

**ä¼˜åŒ–å™¨**å’Œ**åå‘ä¼ æ’­**éƒ½åœ¨è¿™è¾¹å®šä¹‰

```python
optimizer = torch.optim.Adam(
    model.parameters(),           # ä¼ å…¥æ¨¡å‹çš„å‚æ•°
    lr=config['learning_rate'],   # å­¦ä¹ ç‡ï¼ˆä» config å­—å…¸è·å–ï¼‰
    weight_decay=config.get('weight_decay', 1e-4),  # L2 æ­£åˆ™åŒ–ï¼ˆé»˜è®¤å€¼ 1e-4ï¼‰
)
```

4ã€__Hyperparameter__

```python
config = {
    'seed': 804286,   
    'select_all': False,   # æ˜¯å¦é€‰å–æ‰€æœ‰ç‰¹å¾
    'valid_ratio': 0.2,   # validation_size = train_size * valid_ratio
    'n_epochs': 3000,             
    'batch_size': 256, 
    'learning_rate': 1e-5,
    'early_stop': 400,    # å¦‚æœæ¨¡å‹æ²¡æœ‰è¿›æ­¥åˆ™æ—©åœ    
    'save_path': './models/model.ckpt'  # ä¿å­˜æ¨¡å‹
}
```

---

