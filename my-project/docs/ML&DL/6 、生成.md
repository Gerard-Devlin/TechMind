---
subtitle: GAN
---

[TOC]

---

## ä¸€ã€åŸºæœ¬æ¦‚å¿µ

### 1ã€ç»“æ„

#### ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰

- **è¾“å…¥å™ªå£°**ï¼šç”Ÿæˆå™¨æ¥æ”¶ä¸€ä¸ªéšæœºå™ªå£°å‘é‡ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªé«˜ç»´çš„éšæœºå‘é‡ï¼Œæˆ–è€…ä»æ ‡å‡†åˆ†å¸ƒï¼ˆä¾‹å¦‚é«˜æ–¯åˆ†å¸ƒï¼‰ä¸­æŠ½å–ï¼‰ï¼Œè¿™ä¸ªå™ªå£°æ˜¯ç”Ÿæˆå™¨çš„â€œç§å­â€ï¼Œå®ƒå¹¶ä¸ä»£è¡¨ä»»ä½•ç‰¹å®šçš„æ•°æ®æˆ–ä¿¡æ¯ã€‚

- **æ•°æ®ç”Ÿæˆ**ï¼šç”Ÿæˆå™¨é€šè¿‡ä¸€ç³»åˆ—çš„ç¥ç»ç½‘ç»œå±‚ï¼ˆé€šå¸¸æ˜¯å…¨è¿æ¥å±‚ã€å·ç§¯å±‚ç­‰ï¼‰ï¼Œå°†å™ªå£°è½¬åŒ–ä¸ºä¸€ä¸ªæ•°æ®æ ·æœ¬ï¼Œå¯èƒ½æ˜¯å›¾åƒã€éŸ³é¢‘ã€æ–‡æœ¬ç­‰ï¼Œå…·ä½“å–å†³äºç”Ÿæˆçš„ä»»åŠ¡ã€‚

```mermaid
graph LR
	C(x) --> B
    A[Simple Distribution] --> B[Network
ï¼ˆGeneratorï¼‰]
    B --> E(y)
```

- ç®€å•åˆ†å¸ƒçš„æ–¹ç¨‹æˆ‘ä»¬çŸ¥é“ï¼Œæ¯”å¦‚é«˜æ–¯åˆ†å¸ƒã€æ­£æ€åˆ†å¸ƒâ€¦â€¦

??? question  "ä¸ºä»€ä¹ˆè¦åˆ†å¸ƒï¼Ÿ"

    æ¯”å¦‚ç”Ÿæˆè§†é¢‘çš„æ¨¡å‹å•çº¯ä½¿ç”¨ç›‘ç£å­¦ä¹ å¯èƒ½å‡ºç°å‡ºç°é¬¼å½±çš„æƒ…å†µï¼Œè¿™æ—¶å°±åº”è¯¥åŠ å…¥åˆ†å¸ƒ**å¤„ç†å¤šæ ·æ€§å’Œä¸ç¡®å®šæ€§**
    
    - å½“ä»»åŠ¡éœ€è¦åˆ›é€ åŠ›ï¼ˆe.g. ç»˜ç”»ã€chatbot

---

#### åˆ¤åˆ«å™¨ï¼ˆDiscriminatorï¼‰

å®ƒçš„ä»»åŠ¡æ˜¯åŒºåˆ†ç”±ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰ç”Ÿæˆçš„å‡æ•°æ®å’ŒçœŸå®æ•°æ®ã€‚ç»è¿‡å¯¹æŠ—è®­ç»ƒï¼Œç”Ÿæˆå™¨ç”Ÿæˆçš„æ•°æ®è¶Šæ¥è¶ŠçœŸå®ï¼Œåˆ¤åˆ«å™¨åˆ™å˜å¾—è¶Šæ¥è¶Šéš¾ä»¥åˆ†è¾¨çœŸå‡æ•°æ®ã€‚

---

### 2ã€æ— æ¡ä»¶ç”Ÿæˆ

è¿™æ ·çš„æ¨¡å‹ä¼šä»**éšæœºå™ªå£°**ç”Ÿæˆå›¾åƒï¼Œè€Œ**ä¸ä¾èµ–äºä»»ä½•è¾“å…¥**æˆ–æŒ‡å¯¼å›¾åƒå†…å®¹çš„ç‰¹å®šä¿¡æ¯ã€‚

![gan-1.png](../assets/images/DL/gan-1.png)

![gan-2.png](../assets/images/DL/gan-2.png)

---

ç®—æ³•

- step1ï¼šå›ºå®šç”Ÿæˆå™¨ $G$ï¼Œæ›´æ–°åˆ¤åˆ«å™¨ $D$ï¼ˆå°±å½“ä½œåˆ†ç±»çš„é—®é¢˜æ¥åšï¼‰
- step2ï¼šå›ºå®šåˆ¤åˆ«å™¨ $D$ï¼Œæ›´æ–°ç”Ÿæˆå™¨ $G$
- åå¤é‡å¤step1ï¼Œstep2

---

## äºŒã€ç†è®º

### 1ã€ç›®æ ‡å‡½æ•°
**ç›®æ ‡**ï¼šæ˜¯è®­ç»ƒä¸€ä¸ªç”Ÿæˆå™¨ $G$ï¼Œä½¿å…¶å°†ç®€å•çš„åˆ†å¸ƒï¼ˆå¦‚æ­£æ€åˆ†å¸ƒï¼‰è½¬æ¢ä¸ºä¸çœŸå®æ•°æ®åˆ†å¸ƒ $P_{data}$ åŒ¹é…çš„å¤æ‚åˆ†å¸ƒã€‚è¿™æ˜¯é€šè¿‡æœ€å°åŒ–ç”Ÿæˆåˆ†å¸ƒ $P_G$ ä¸çœŸå®æ•°æ®åˆ†å¸ƒ $P_{data}$ ä¹‹é—´çš„æ•£åº¦ $\text{Div}(P_G, P_{data})$ æ¥å®ç°çš„ã€‚

$$
G^*=\arg\min_G Div(P_{G},P_{Data})
$$

**è®­ç»ƒ**ï¼š$D^* = \arg \max_D V(D, G)$

åˆ¤åˆ«å™¨Dçš„**ç›®æ ‡å‡½æ•°**ï¼š

$$
V(G, D) = \mathbb{E}_{y \sim P_{data}}[\log D(y)] + \mathbb{E}_{y \sim P_G}[\log(1 - D(y))] 
$$

!!! tip 
	- å«ç›®æ ‡å‡½æ•°æ˜¯å› ä¸ºè¦maximizeï¼Œå«Lossæ˜¯è¦minimize
	- è¿™ä¸ªå°±æ˜¯ ==cross-entropy== å–è´Ÿå·ï¼Œæœ€å¤§åŒ–ç›®æ ‡å‡½æ•°å¯ä»¥å½“ä½œå°±æ˜¯æœ€å°åŒ–Loss

$$
G^*=\arg\min_G \max_D V(G,D)
$$

- è¿™ä¸ªç­‰å¼çš„è¿‡ç¨‹å°±æ˜¯å‰é¢æ‰€è¯´çš„ç”Ÿæˆå™¨å’Œåˆ¤åˆ«å™¨çš„è¿­ä»£è¿‡ç¨‹

---

## ä¸‰ã€è®­ç»ƒæŠ€å·§ - WGAN

!!! danger "$JS$ æ•£åº¦ä¸é€‚åˆ"  
    - â‘ $P_G, P_{data}$ æ˜¯åœ¨é«˜ç»´ä¸­çš„ä½ç»´æµå½¢ï¼ˆmanifoldï¼‰
    - â‘¡åªè¦é‡‡æ ·ä¸å¤Ÿå¤šï¼Œé‚£ä¹ˆäº¤å åŒºåŸŸä¼šå¾ˆå°
    
    åªè¦åˆ†å¸ƒä¸é‡åˆé‚£ä¹ˆ$JS(P_G, P_{data})=\log2$ æ’æˆç«‹ $\Rightarrow$ å¦‚æœä¸¤ä¸ªåˆ†å¸ƒå®Œå…¨ä¸é‡å ï¼Œ**äºŒå…ƒåˆ†ç±»å™¨**å¯ä»¥è¾¾åˆ°100%çš„å‡†ç¡®ç‡ã€‚åœ¨GANè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå‡†ç¡®ç‡ï¼ˆæˆ–æŸå¤±ï¼‰å¯èƒ½æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºå³ä½¿ç”Ÿæˆå™¨åˆ†å¸ƒä¸çœŸå®æ•°æ®åˆ†å¸ƒå®Œå…¨ä¸åŒï¼ŒJSæ•£åº¦ä»ç„¶å¯ä»¥ä¿æŒä¸å˜ã€‚


$Wasserstein$ è·ç¦»ï¼š

å¯ä»¥è¢«ç›´è§‚åœ°ç†è§£ä¸ºï¼šå‡è®¾æœ‰ä¸¤ä¸ªåˆ†å¸ƒï¼Œä¸€ä¸ªæ˜¯æºåˆ†å¸ƒï¼Œå¦ä¸€ä¸ªæ˜¯ç›®æ ‡åˆ†å¸ƒï¼Œ$Wasserstein$ è·ç¦»å°±æ˜¯å°†æºåˆ†å¸ƒâ€œç§»åŠ¨â€åˆ°ç›®æ ‡åˆ†å¸ƒæ‰€éœ€çš„æœ€å°â€œå·¥ä½œé‡â€ã€‚è¿™é‡Œçš„â€œå·¥ä½œé‡â€æ˜¯æ ¹æ®åˆ†å¸ƒä¹‹é—´çš„â€œè·ç¦»â€æ¥è®¡ç®—çš„ã€‚

ç”¨$Wasserstein$ è·ç¦»ä»£æ›¿$JS$ æ•£åº¦å°±æ˜¯WGAN:

$$
D_{Wasserstein}=\max_{D \in 1-Lipschitz} \left\{ \mathbb{E}_{y \sim P_{data}}[D(x)] - \mathbb{E}_{y \sim P_G}[D(x)] \right\}
$$

$D \in 1-Lipschitz \Rightarrow$Då¿…é¡»æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¹³æ»‘çš„åˆ†å¸ƒ

??? tip
    - **Tips from Soumith**
        - [https://github.com/soumith/ganhacks](https://github.com/soumith/ganhacks)
      - **Tips in DCGAN: Guideline for network architecture design for image generation**
          - [https://arxiv.org/abs/1511.06434](https://arxiv.org/abs/1511.06434)
      - **Improved techniques for training GANs**
          - [https://arxiv.org/abs/1606.03498](https://arxiv.org/abs/1606.03498)
      - **Tips from BigGAN**
          - [https://arxiv.org/abs/1809.11096](https://arxiv.org/abs/1809.11096)

!!! warning
    
    GANç”Ÿæˆæ–‡å­—ï¼ˆåºåˆ—ï¼‰ï¼šæ”¹å˜decoderè¾“å‡ºï¼Œä¸å½±å“æœ€å¤§çš„tokenï¼Œåˆ†å¸ƒæ²¡æœ‰å˜åŒ–ï¼Œå¯¼è‡´åˆ¤åˆ«å™¨è¾“å‡ºçš„åˆ†æ•°æ²¡æœ‰å˜åŒ–ï¼Œæ‰€ä»¥**ä¸èƒ½æ¢¯åº¦ä¸‹é™**
    èƒ½ä¸èƒ½ä½¿ç”¨ç›‘ç£å­¦ä¹ çš„æ–¹æ³•ï¼ŒæŠŠä¸€å¼ å›¾ç‰‡å½“ä½œå‘é‡ç„¶åè®­ç»ƒï¼Ÿâ†’ å¯ä»¥ï¼Œä½†æ˜¯ä¹Ÿå¾ˆéš¾


---

## å››ã€è¡¡é‡ç”Ÿæˆè´¨é‡

- äººçœ¼è¡¡é‡âŒ
- å¯¹äº**ä¸€å¼ å›¾**ï¼šè·‘ä¸€ä¸ªå½±åƒåˆ†ç±»å™¨ï¼Œçœ‹**åˆ†å¸ƒæ˜¯å¦é›†ä¸­**ï¼Œé›†ä¸­è¯´æ˜**è´¨é‡**ï¼ˆQualityï¼‰å¤Ÿé«˜ â†’ ä¹Ÿä¼šæœ‰é—®é¢˜ **==æ¨¡å¼å´©æºƒï¼ˆMode Collapseï¼‰==**ï¼šç”Ÿæˆé‡å¤å†…å®¹
- **==æ¨¡å¼æ‰è½ï¼ˆModel Droppingï¼‰==**ï¼šäº§ç”Ÿçš„ä»ç„¶ä¸çœŸå®åˆ†å¸ƒæœ‰å·®å¼‚ç¼ºä¹**å¤šæ ·æ€§**ï¼ˆDiversityï¼‰
- å¯¹äº**ä¸€å †å›¾**ï¼šè·‘ä¸€ä¸ªå½±åƒåˆ†ç±»å™¨ï¼Œçœ‹**åˆ†å¸ƒæ˜¯å¦åˆ†æ•£**ï¼Œåˆ†æ•£è¯´æ˜**å¤šæ ·æ€§**è¶³å¤Ÿ

1ï¸âƒ£ä½¿ç”¨ISï¼ˆInception Scoreï¼‰

$$
 P(c) = \frac{1}{N} \sum_{n} P(c|y^n) 
$$

2ï¸âƒ£ä½¿ç”¨FIDï¼ˆFrÃ©chet Inception Distanceï¼‰âœ…

- æ‹¿å‡ºè¿›å…¥softmaxå‰çš„ç‰¹å¾å‘é‡æ¥è®¡ç®—FrÃ©chet Distanceï¼Œä¹Ÿç§°ä¸ºWasserstein-2è·ç¦»ã€‚è¿™ä¸ªè·ç¦»è¡¡é‡äº†ä¸¤ä¸ªå¤šå˜é‡**é«˜æ–¯åˆ†å¸ƒ**ä¹‹é—´çš„å·®å¼‚

![gan-3.png](../assets/images/DL/gan-3.png)

ä½†æ˜¯è¿™ä¸ªå®éªŒä½¿ç”¨çš„ç½‘ç»œæ¶æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æŸäº›GANå¯¹äºæŸäº›æ¶æ„æ›´æœ‰åå¥½æ‰€ä»¥éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶æ¥éªŒè¯

---

## äº”ã€æœ‰æ¡ä»¶ç”Ÿæˆ

æ— æ¡ä»¶ç”Ÿæˆæ˜¯ï¼šæ¨¡å‹ä¼šä»**éšæœºå™ªå£°**ç”Ÿæˆå›¾åƒï¼Œè€Œ**ä¸ä¾èµ–äºä»»ä½•è¾“å…¥**æˆ–æŒ‡å¯¼å›¾åƒå†…å®¹çš„ç‰¹å®šä¿¡æ¯ã€‚

æœ‰æ¡ä»¶ç”Ÿæˆæ˜¯ï¼š

- ä¾èµ–**è¾“å…¥**+**åˆ†å¸ƒ**

- åº”ç”¨ï¼šText-to-imageï¼Œå›¾ç‰‡äº§ç”Ÿå›¾ç‰‡ï¼ˆpix2pixï¼‰

**åˆ¤åˆ«å™¨**è¦æœ‰æ‰€æ”¹å˜ï¼Œéœ€è¦è€ƒè™‘åˆ°è¾“å…¥çš„æ–‡å­—ã€‚è¾“å…¥èµ„æ–™æ˜¯æœ‰æ ‡æ³¨çš„**æˆå¯¹èµ„æ–™**ï¼ˆæ–‡å­—+å›¾ç‰‡â€¦â€¦ï¼‰

!!! danger "ä½¿ç”¨ç›‘ç£å­¦ä¹ å¯èƒ½ä¼šäº§ç”Ÿæ¨¡ç³Šï¼Œé¬¼å½±"
	ç›‘ç£å­¦ä¹ +GAN æ•ˆæœæœ€å¥½

---

## å…­ã€Cycle GAN

- ä»ä¸æˆå¯¹èµ„æ–™å­¦ä¹ 
- åº”ç”¨ï¼šæ–‡å­—/å›¾ç‰‡é£æ ¼è½¬æ¢

![gan-4.png](../assets/images/DL/gan-4.png)

![gan-5.png](../assets/images/DL/gan-5.png)

1. **ä¸¤ä¸ªç”Ÿæˆå™¨ï¼ˆGeneratorsï¼‰ï¼š**
    - $G_{X \to Y}$ï¼šå°† **åŸŸ Xï¼ˆå¦‚çœŸäººç…§ç‰‡ï¼‰** è½¬æ¢ä¸º **åŸŸ Yï¼ˆå¦‚åŠ¨æ¼«é£æ ¼å›¾åƒï¼‰**ã€‚
      - $G_{Y \to X}$ï¼šå°† **åŸŸ Yï¼ˆå¦‚åŠ¨æ¼«é£æ ¼å›¾åƒï¼‰** è½¬æ¢å› **åŸŸ Xï¼ˆå¦‚çœŸäººç…§ç‰‡ï¼‰**ã€‚
2. **ä¸¤ä¸ªåˆ¤åˆ«å™¨ï¼ˆDiscriminatorsï¼‰ï¼š**
    - $D_Y$ï¼šç”¨äºåˆ¤æ–­è¾“å…¥çš„å›¾åƒæ˜¯å¦å±äº **åŸŸ Y**ï¼ˆå¦‚åŠ¨æ¼«é£æ ¼å›¾åƒï¼‰ã€‚
      - $D_X$ï¼šç”¨äºåˆ¤æ–­è¾“å…¥çš„å›¾åƒæ˜¯å¦å±äº **åŸŸ X**ï¼ˆå¦‚çœŸäººç…§ç‰‡ï¼‰ã€‚
      - åˆ¤åˆ«å™¨çš„ç›®æ ‡æ˜¯æå‡ç”Ÿæˆå›¾åƒçš„çœŸå®æ€§ï¼Œè®©è½¬æ¢åçš„å›¾åƒæ›´è´´è¿‘ç›®æ ‡åŸŸçš„çœŸå®æ•°æ®åˆ†å¸ƒã€‚
3. **å¾ªç¯ä¸€è‡´æ€§ï¼ˆCycle Consistencyï¼‰ï¼š**
    - CycleGAN çš„æ ¸å¿ƒæ€æƒ³æ˜¯**è½¬æ¢åçš„å›¾åƒå†è½¬æ¢å›æ¥ï¼Œåº”è¯¥å°½é‡æ¥è¿‘åŸå§‹å›¾åƒ**ã€‚
      - ä¾‹å¦‚ï¼Œä¸€ä¸ª **çœŸäººç…§ç‰‡ $X$ ç»è¿‡ $G_{X \to Y}$ å˜æˆåŠ¨æ¼«é£æ ¼ $Y$**ï¼Œå†ç»è¿‡ $G_{Y \to X}$ å˜å› **çœŸäººç…§ç‰‡**ï¼Œåº”å°½å¯èƒ½ä¸åŸæ¥çš„ $X$ è´´è¿‘ã€‚
      - åä¹‹ï¼Œä¸€ä¸ª **åŠ¨æ¼«é£æ ¼å›¾åƒ $Y$ ç»è¿‡ $G_{Y \to X}$ å˜æˆäººè„¸ $X$**ï¼Œå†ç»è¿‡ $G_{X \to Y}$ å˜å›åŠ¨æ¼«é£æ ¼å›¾åƒ $Y$ï¼Œä¹Ÿåº”å°½é‡ä¸åŸå›¾ä¸€è‡´ã€‚

**å…³é”®ç‚¹æ€»ç»“**

- **æ— ç›‘ç£å­¦ä¹ **ï¼šä¸éœ€è¦æˆå¯¹çš„æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œé€‚ç”¨äºé£æ ¼è½¬æ¢ã€å›¾åƒå¢å¼ºç­‰ä»»åŠ¡ã€‚
- **GAN æŸå¤±**ï¼šé€šè¿‡åˆ¤åˆ«å™¨ $D_X$ å’Œ $D_Y$ ç¡®ä¿è½¬æ¢åçš„å›¾åƒç¬¦åˆç›®æ ‡åŸŸçš„ç‰¹å¾ã€‚
- **å¾ªç¯ä¸€è‡´æ€§æŸå¤±**ï¼šç¡®ä¿è½¬æ¢åçš„å›¾åƒåœ¨åŒå‘æ˜ å°„åå°½å¯èƒ½æ¥è¿‘åŸå§‹å›¾åƒã€‚

---

## ğŸŒŸ HW06

<div class="grid cards" markdown>

- [:fontawesome-brands-git-alt: __HW06__ reference code -- â€œ__GAN__â€](https://github.com/Gerard-Devlin/NTU-EE5184/tree/main/HW06)

</div>

!!! tip
    åŸæœ¬ä»£ç ä½¿ç”¨DCGANï¼Œå¯ä»¥æ”¹è¿›ä¸ºWGAN/WGAN-GPï¼Œéœ€è¦è¾¾åˆ°è¾ƒå¥½çš„æ•ˆæœéœ€è¦ä½¿ç”¨StyleGan

1.**WGAN**ï¼šä»DCGANä¿®æ”¹è€Œæ¥

- ä»åˆ¤åˆ«å™¨ä¸­ç§»é™¤æœ€åçš„sigmoidå±‚ã€‚
- åœ¨è®¡ç®—æŸå¤±æ—¶ä¸å–å¯¹æ•°ã€‚
- å°†åˆ¤åˆ«å™¨çš„æƒé‡é™åˆ¶åœ¨ä¸€ä¸ªå¸¸æ•°ï¼ˆ1 ~ -1ï¼‰èŒƒå›´å†…ã€‚
- ä½¿ç”¨RMSPropæˆ–SGDä½œä¸ºä¼˜åŒ–å™¨ã€‚

2.**WGAN-GP**ï¼šä»**WGAN**ä¿®æ”¹è€Œæ¥

- ä½¿ç”¨æ¢¯åº¦æƒ©ç½šæ¥æ›¿ä»£æƒé‡è£å‰ªã€‚
- æ¢¯åº¦æƒ©ç½šç´¯ç§¯æ¥è‡ªæ’å€¼å›¾åƒçš„æ¢¯åº¦ã€‚

```python
# Generator

class Generator(nn.Module):
    """
    Input shape: (batch, in_dim)
    Output shape: (batch, 3, 64, 64)
    """
    def __init__(self, in_dim, feature_dim=64):
        super().__init__()
    
        #input: (batch, 100)
        self.l1 = nn.Sequential(
            nn.Linear(in_dim, feature_dim * 8 * 4 * 4, bias=False),
            nn.BatchNorm1d(feature_dim * 8 * 4 * 4),
            nn.ReLU()
        )
        self.l2 = nn.Sequential(
            self.dconv_bn_relu(feature_dim * 8, feature_dim * 4),               #(batch, feature_dim * 16, 8, 8)     
            self.dconv_bn_relu(feature_dim * 4, feature_dim * 2),               #(batch, feature_dim * 16, 16, 16)     
            self.dconv_bn_relu(feature_dim * 2, feature_dim),                   #(batch, feature_dim * 16, 32, 32)     
        )
        self.l3 = nn.Sequential(
            nn.ConvTranspose2d(feature_dim, 3, kernel_size=5, stride=2,
                               padding=2, output_padding=1, bias=False),
            nn.Tanh()   
        )
        self.apply(weights_init)
    def dconv_bn_relu(self, in_dim, out_dim):
        return nn.Sequential(
            nn.ConvTranspose2d(in_dim, out_dim, kernel_size=5, stride=2,
                               padding=2, output_padding=1, bias=False),        #double height and width
            nn.BatchNorm2d(out_dim),
            nn.ReLU(True)
        )
    def forward(self, x):
        y = self.l1(x)
        y = y.view(y.size(0), -1, 4, 4)
        y = self.l2(y)
        y = self.l3(y)
        return y
```

```python
# Discriminator
class Discriminator(nn.Module):
    """
    Input shape: (batch, 3, 64, 64)
    Output shape: (batch)
    """
    def __init__(self, in_dim, feature_dim=64):
        super(Discriminator, self).__init__()
            
        #input: (batch, 3, 64, 64)
        """
        NOTE FOR SETTING DISCRIMINATOR:

        Remove last sigmoid layer for WGAN
        """
        self.l1 = nn.Sequential(
            nn.Conv2d(in_dim, feature_dim, kernel_size=4, stride=2, padding=1), #(batch, 3, 32, 32)
            nn.LeakyReLU(0.2),
            self.conv_bn_lrelu(feature_dim, feature_dim * 2),                   #(batch, 3, 16, 16)
            self.conv_bn_lrelu(feature_dim * 2, feature_dim * 4),               #(batch, 3, 8, 8)
            self.conv_bn_lrelu(feature_dim * 4, feature_dim * 8),               #(batch, 3, 4, 4)
            nn.Conv2d(feature_dim * 8, 1, kernel_size=4, stride=1, padding=0),
            nn.Sigmoid() 
        )
        self.apply(weights_init)
    def conv_bn_lrelu(self, in_dim, out_dim):
        """
        NOTE FOR SETTING DISCRIMINATOR:

        You can't use nn.Batchnorm for WGAN-GP
        Use nn.InstanceNorm2d instead
        """

        return nn.Sequential(
            nn.Conv2d(in_dim, out_dim, 4, 2, 1),
            nn.BatchNorm2d(out_dim),
            nn.LeakyReLU(0.2),
        )
    def forward(self, x):
        y = self.l1(x)
        y = y.view(-1)
        return y
```



---

